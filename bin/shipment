#!/bin/bash
set -e

VERSION="0.19.0"
BRIDGE_IP=172.17.42.1
SHIPMENTPATH=/var/shipment
SHIPMENTCONFIG=$SHIPMENTPATH/config
APPSPATH=$SHIPMENTPATH/apps
SCRIPT=$0

DIR=$(dirname $0)

usage() {
  cat <<-EOF

  Usage: shipment [command]

  Commands:

EOF

for f in $DIR/shipment-*; do
  cmd=${f/$DIR\/shipment-/}
  printf "    %-20s %-50s\n" "$cmd" "$($f _description)"
done
echo

exit
}

version() {
  echo $VERSION
}

log() {
  echo -e "  \e[33m$@\e[39m"
}

abort() {
  echo
  echo -e "  \e[31m$@\e[39m" 1>&2
  echo
  exit 1
}

check_sudo() {
  if [[ $(/usr/bin/id -u) -ne 0 ]]; then
    echo "Must run as root"
    exit
  fi
}

get_commit() {
  local name=$1
  cd $APPSPATH/$name
  echo $(git log --pretty=format:'%h' -n 1)
}

readconfig() {
  local name=$1
  if [[ ! -f $SHIPMENTCONFIG/$name ]]; then
    log "$name config not found. Must call shipment create first"
    exit 1
  fi

  local configstr=$(cat $SHIPMENTCONFIG/$name)

  parseconfig $configstr
}

parseconfig() {
  port=5000
  env=()
  volume=()
  link=()
  while (( "$#" )); do
    case "$1" in
      -r|--repo)
        repo=$2
        shift 2
        ;;
      -h|--host)
        host=$2
        shift 2
        ;;
      -p|--port)
        port=$2
        shift 2
        ;;
      -e|--env)
        env+=($2)
        shift 2
        ;;
      -v|--volume)
        volume+=($2)
        shift 2
        ;;
      -l|--link)
        link+=($2)
        shift 2
        ;;
      --) # end argument parsing
        shift
        break
        ;;
      -*|--*=) # unsupported flags
        log "Error: Unsupported flag $1" >&2
        exit 1
        ;;
      *) # preserve positional arguments
        params+=($1)
        shift
        ;;
    esac
  done
  # set positional arguments in their proper place
  eval set -- "$params"
  if [[ ${#params[@]} == 0 ]]; then
    log "Must pass in name of app"
    exit 1
  fi
  name=${params[0]}
}

writeconfig() {
  if [[ ! -d $SHIPMENTCONFIG ]]; then
    mkdir -p $SHIPMENTCONFIG
  fi

  local name=$1
  shift
  echo $@ > $SHIPMENTCONFIG/$name

}

if [ "$#" == 0 ]; then
  usage
fi

CMD=$1
shift
case $CMD in
  --version)
    version
    exit
    ;;
  *)
    exec="$DIR/shipment-$CMD"
    if [ -f "$exec" ]; then
      . $exec "$@"
    else
      log "command doesn't exist"
      usage
    fi
    ;;
esac

