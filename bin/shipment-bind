#!/bin/bash
set -e

PORT=5000

if [ "$1" == "_description" ]; then
  echo "Bind host to container"
  exit
fi

usage_bind() {
  cat <<-EOF

  Usage: shipment bind [options]

  Deploy options:

    Required:
    -n <name>            name and tag [some-cool-app:a186acb]
    -i <id>              container id
    -u <url>             host url [app.com]
    -p <port>            port [default: 5000]

EOF
}

while getopts ":u:n:i:p:" OPTION "$@"; do
  case $OPTION in
    u) URL=$OPTARG;;
    n) NAME=$OPTARG;;
    i) CONTAINER_ID=$OPTARG;;
    p) PORT=$OPTARG;;
  esac
done

if [[ -z "$URL" ]]; then
  usage_bind
  exit 1
fi

if [[ -n "$NAME" ]]; then
  ids=$(shipment running -i -n $NAME)
  for container_id in ${ids[@]}; do
    shipment bind -u $URL -i $container_id
  done
  exit 0
fi


container_port=$(sudo docker port $CONTAINER_ID $PORT | sed 's/0.0.0.0://')

if [ -z $container_port ]; then
  log "Invalid container id"
  exit;
fi

redis_key="frontend:$URL"
count=$(redis "llen $redis_key")

if [[ "$count" == "0" ]]; then
  redis "rpush $redis_key app" > /dev/null
fi

url="http://$BRIDGE_IP:$container_port"

log "Binding $url to $URL"
redis "rpush $redis_key $url" > /dev/null
