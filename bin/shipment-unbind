#!/bin/bash
set -e

PORT=5000

if [ "$1" == "_description" ]; then
  echo "Unbind host from container"
  exit
fi

usage_unbind() {
  cat <<-EOF

  Usage: shipment unbind [options]

  Deploy options:

    Required:
    -n <name>            name and tag [some-cool-app:a186acb]
    -i <id>              container id
    -u <url>             host url [app.com]
    -p <port>            port [default: 5000]

EOF
}

while getopts ":u:n:i:p:" OPTION "$@"; do
  case $OPTION in
    u) URL=$OPTARG;;
    n) NAME=$OPTARG;;
    i) CONTAINER_ID=$OPTARG;;
    p) PORT=$OPTARG;;
  esac
done

if [[ -z "$URL" ]]; then
  usage_unbind
  exit 1
fi

if [[ -n "$NAME" ]]; then
  ids=$(shipment running -i -n $NAME)
  for container_id in ${ids[@]}; do
    shipment unbind -u $URL -i $container_id
  done
  exit 0
fi


container_port=$(sudo docker port $CONTAINER_ID $PORT | sed 's/0.0.0.0://')

if [ -z $container_port ]; then
  log "Invalid container id"
  exit;
fi

redis_key="frontend:$URL"
url="http://$BRIDGE_IP:$container_port"

log "Unbinding $url from $URL"
redis "lrem $redis_key 0 $url" > /dev/null
