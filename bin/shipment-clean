#!/bin/bash
set -e

if [ "$1" == "_description" ]; then
  echo "Clean old app images"
  exit
fi

usage_clean() {
  echo "shipment clean -s [skip count] [app name]"
}

if [ "$#" == 0 ]; then
  usage_clean
  exit
fi


main() {
  local skip=0;

  while (( "$#" )); do
    case "$1" in
      -s|--skip)
        skip=$2
        shift 2
        ;;
      --) # end argument parsing
        shift
        break
        ;;
      -*|--*=) # unsupported flags
        log "Error: Unsupported flag $1" >&2
        exit 1
        ;;
      *) # preserve positional arguments
        params+=($1)
        shift
        ;;
    esac
  done
  # set positional arguments in their proper place
  eval set -- "$params"
  local name=${params[0]}

  log "Cleaning $name images"
  docker rmi $(docker images | grep "shipment/$name " | tail -n +$skip | awk '{print $3 }')
}
main "$@"
