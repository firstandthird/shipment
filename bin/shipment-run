#!/bin/bash
set -e

if [ "$1" == "_description" ]; then
  echo "Run an app"
  exit
fi

main() {

  local branch="master"
  local params=()
  while (( "$#" )); do
    case "$1" in
      -b|--branch)
        branch=$2
        shift 2
        ;;
      --) # end argument parsing
        shift
        break
        ;;
      -*|--*=) # unsupported flags
        log "Error: Unsupported flag $1" >&2
        exit 1
        ;;
      *) # preserve positional arguments
        params+=($1)
        shift
        ;;
    esac
  done
  # set positional arguments in their proper place
  eval set -- "$params"
  local name=${params[0]}

  readconfig $name

  local dockerargs=""

  if [[ -n "$link" ]]; then
    for i in ${link[@]}; do
      dockerargs+=" --link $i"
    done
  fi

  if [[ -n "$env" ]]; then
    for i in ${env[@]}; do
      dockerargs+=" --env $i"
    done
  fi

  if [[ -n "$volume" ]]; then
    for i in ${volume[@]}; do
      dockerargs+=" --volume $i"
    done
  fi

  local container_id=$(docker run -d $dockerargs -p $port -e VIRTUAL_HOST=$host -e PORT=$port shipment/$name:$branch)
  echo $container_id
}
main "$@"
