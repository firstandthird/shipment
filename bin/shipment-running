#!/bin/bash
set -e

if [ "$1" == "_description" ]; then
  echo "List running apps"
  exit
fi

usage_running() {
  cat <<-EOF

  Usage: shipment running [options] [name]

  Options:

    Optional:
    -i,--ids                      only return ids
    -c,--count                    only return number of running containers
    -a,--all                      show stopped containers too

EOF
}

main() {
  local ids=0
  local count=0
  local all=0
  while (( "$#" )); do
    case "$1" in
      -i|--id|--ids)
        ids=1
        shift 1
        ;;
      -c|--count)
        count=1
        shift 1
        ;;
      -a|--all)
        all=1
        shift 1
        ;;
      --help)
        usage_running
        exit 0
        ;;
      --) # end argument parsing
        shift
        break
        ;;
      -*|--*=) # unsupported flags
        log "Error: Unsupported flag $1" >&2
        exit 1
        ;;
      *) # preserve positional arguments
        params+=($1)
        shift
        ;;
    esac
  done
  # set positional arguments in their proper place
  eval set -- "$params"
  local name=${params[0]}

  if [[ -z "$name" ]]; then
    log "app name is required"
    exit 1
  fi

  if [[ "$count" == "1" ]]; then
    docker ps | grep shipment/$name | wc -l
    exit 0
  fi

  if [[ "$all" == "1" ]]; then
    local all_param="-a"
  fi

  if [ "$ids" == 0 ]; then
    printf "%-30s %-20s \n" "APP:TAG" "ID"
    docker ps $all_param | grep "shipment/$name" | awk '{ printf("%-30s %-20s \n", $2, $1) }'
  else
    docker ps $all_param | grep "shipment/$name" | awk '{ print $1 }'
  fi
}

main "$@"

