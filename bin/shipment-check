#!/bin/bash
set -e

if [ "$1" == "_description" ]; then
  echo "Run a curl against the app to see if running"
  exit
fi

usage_running() {
  cat <<-EOF

  Usage: shipment check [options] [id]

  Options:

    Optional:
    -p,--port <port>              port to check [default: 5000]

EOF
}

main() {
  local port=5000

  while (( "$#" )); do
    case "$1" in
      -p|--port)
        port=$2
        shift 2
        ;;
      --) # end argument parsing
        shift
        break
        ;;
      -*|--*=) # unsupported flags
        log "Error: Unsupported flag $1" >&2
        exit 1
        ;;
      *) # preserve positional arguments
        params+=($1)
        shift
        ;;
    esac
  done
  # set positional arguments in their proper place
  eval set -- "$params"
  local id=${params[0]}

  local ip=$(docker inspect --format '{{ .NetworkSettings.IPAddress }}' $id)
  log "Checking $id on port $port"

  local maxattempts=60
  local attempts=0
  until $(curl --output /dev/null --silent --head --fail http://$ip:$port); do
      printf '.'
      sleep 1
      attempts=$(($attempts+1))
      if [[ "$maxattempts" == "$attempts" ]]; then
        log "Reached max attemps, exiting"
        exit 1
      fi
  done
  log "$id is running"
}

main "$@"

