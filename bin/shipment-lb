#!/bin/bash
set -e

if [ "$1" == "_description" ]; then
  echo "Manage load balancer"
  exit
fi

CMD=$1
shift
case $CMD in
  start)
    id=$(docker ps -a | grep shipment-nginx | awk '{ print $1 }')
    mkdir -p /tmp/shipment-lb
    if [ -z "$id" ]; then
      log "Starting nginx"
      docker run \
        -d -p 80:80 -p 443:443 \
        --name shipment-nginx \
        -v $SHIPMENTPATH/certs:/etc/nginx/certs \
        -v /tmp/shipment-lb:/etc/nginx/conf.d \
        nginx:1.9.3
    else
      docker start $id
    fi
    log "Load Balancer running"
    exec $SCRIPT lb update
    exit
    ;;
  stop)
    id=$(docker ps | grep shipment-nginx | awk '{ print $1 }')
    echo $id
    if [ -n "$id" ]; then
      log "Stopping nginx"
      docker stop $id
      docker rm $id
    fi
    log "Load Balancer stopped"
    exit
    ;;
  update)
    (exec $SCRIPT lb copy-conf)
    log "Updating load balancer config"
    docker run --rm --volumes-from shipment-nginx \
        -v /var/run/docker.sock:/tmp/docker.sock \
        -v $SHIPMENTPATH/nginx:/etc/docker-gen/templates \
        --name shipment-dockergen \
        jwilder/docker-gen:0.4.0 -notify-sighup shipment-nginx -only-published /etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf
    exit
    ;;
  restart)
    (exec $SCRIPT lb stop)
    (exec $SCRIPT lb start)
    (exec $SCRIPT lb update)
    exit
    ;;
  tail)
    docker logs --tail=100 -f shipment-nginx
    exit
    ;;

  copy-conf)
    log "Copying conf files to nginx"
    for f in $SHIPMENTPATH/nginx/*.conf; do
      if [[ -f "$f" ]]; then
        cp -v $f /tmp/shipment-lb
      fi
    done
    exit
    ;;
  reload)
    docker kill -s HUP shipment-nginx > /dev/null
    log "nginx reloaded"
    exit
    ;;
esac

