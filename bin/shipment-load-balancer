#!/bin/bash
set -e

if [ "$1" == "_description" ]; then
  echo "Manage load balancer"
  exit
fi

CMD=$1
shift
case $CMD in
  start)
    id=$(sudo docker ps -a | grep shipment-nginx | awk '{ print $1 }')
    mkdir -p /tmp/nginx
    if [ -z "$id" ]; then
      log "Starting nginx"
      sudo docker run -d -p 80:80 -p 443:443 --name shipment-nginx -v $SHIPMENTPATH/ssl:/ssl -v /tmp/nginx:/etc/nginx/conf.d -t nginx
    else
      sudo docker start $id
    fi
    log "Load Balancer running"
    exit
    ;;
  stop)
    id=$(sudo docker ps | grep shipment-nginx | awk '{ print $1 }')
    if [ -z "$id" ]; then
      log "Stopping nginx"
      shipment stop -i $id
    fi
    id=$(sudo docker ps | grep shipment-docker-gen | awk '{ print $1 }')
    if [ -z "$id" ]; then
      log "Stopping docker-gen"
      shipment stop -i $id
    fi
    log "Load Balancer stopped"
    exit
    ;;
  update)
    log "Updating load balancer config"
    sudo docker run --rm --volumes-from shipment-nginx \
        -v /var/run/docker.sock:/tmp/docker.sock \
        -v $SHIPMENTPATH/nginx:/etc/docker-gen/templates \
        jwilder/docker-gen:0.3.4 -notify-sighup shipment-nginx -only-published /etc/docker-gen/templates/nginx.tmpl /etc/nginx/conf.d/default.conf
    exit
    ;;
  restart)
    shipment load-balancer stop
    shipment load-balancer start
    shipment load-balancer update
    exit
    ;;

esac

