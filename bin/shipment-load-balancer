#!/bin/bash
set -e

if [ "$1" == "_description" ]; then
  echo "Manage load balancer"
  exit
fi

CMD=$1
shift
case $CMD in
  start)
    REDISID=$(sudo docker ps | grep shipment-redis | awk '{ print $1 }')
    if [ -z "$REDISID" ]; then
      log "Starting redis"
      sudo docker run -d --restart=on-failure:5 --name shipment-redis redis
    fi
    ID=$(sudo docker ps | grep shipment-load-balancer | awk '{ print $1 }')
    if [ -z "$ID" ]; then
      sudo docker run -d -p 80:80 --restart=on-failure:5 -v /var/log/shipment:/var/log/shipment -v /etc/shipment/:/hipache/config/ --env HIPACHE_DRIVER="redis://\$REDIS_PORT_6379_TCP_ADDR:\$REDIS_PORT_6379_TCP_PORT" --link shipment-redis:redis --name shipment-load-balancer firstandthird/hipache
      log "Load balancer started"
    else
      log "Load balancer already started"
    fi
    exit
    ;;
  stop)
    ID=$(sudo docker ps | grep shipment-load-balancer | awk '{ print $1 }')
    if [ -n "$ID" ]; then
      log "Stopping load balancer"
      shipment stop -i $ID
    else
      log "Load balancer not running"
    fi
    exit
    ;;
  redis)
    cmd="exec redis-cli -h \"\$REDIS_PORT_6379_TCP_ADDR\" -p \"\$REDIS_PORT_6379_TCP_PORT\" $@"
    sudo docker run -it --link shipment-redis:redis --rm redis sh -c "$cmd"
    exit
    ;;
  restart)
    shipment load-balancer stop
    shipment load-balancer start
    exit
    ;;

esac

